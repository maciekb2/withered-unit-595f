<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Generowanie artyku≈Çu</title>
<style>
body { font-family: sans-serif; padding: 2rem; }
#log {
  white-space: pre-wrap;
  background: #f4f4f4;
  padding: 1rem;
  border-radius: 4px;
  max-height: 60vh;
  overflow-y: auto;
  margin-top: 1em;
}
#panel {
  margin-bottom: 1em;
  border: 1px solid #ddd;
  padding: 1rem;
  border-radius: 4px;
  background: #fafafa;
}
#footer {
  margin-top: 2em;
}
.home-button { display: inline-block; padding: 0.75em 1.5em; background: var(--diplomatic-blue, #1c3d5a); color: var(--ivory, #f8f6f1); border-radius: 4px; text-decoration: none; border: 2px solid var(--diplomatic-blue, #1c3d5a); margin-right: 1em; }
.home-button:hover { background: var(--gold-accent, #cba135); color: var(--charcoal, #2d2d2d); }
textarea { width: 100%; height: 8em; }

</style>
</head>
<body>
<h1>Generowanie artyku≈Çu</h1>
<div id="panel">
  <div id="status">Oczekiwanie na dane...</div>

  <div id="log"></div>

  <textarea id="article-prompt" style="display:none" readonly></textarea>
  <button id="continue-btn" style="display:none">Kontynuuj</button>
</div>
<div id="footer">
  <a id="pr-link" class="home-button" style="display:none">Zobacz PR</a>
  <a href="/" class="home-button">Strona g≈Ç√≥wna</a>
</div>

<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const articlePromptEl = document.getElementById('article-prompt');
const prLinkEl = document.getElementById('pr-link');
const continueBtn = document.getElementById('continue-btn');
let promptShown = false;
let topicForm;

function sendLog(event, details = {}) {
  fetch('/api/client-log', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ event, ...details }),
    credentials: 'include',
    keepalive: true,
  }).catch(() => {});
}

startStream();

function appendLog(text) {
  const div = document.createElement('div');
  div.textContent = text;
  logEl.appendChild(div);
  logEl.scrollTop = logEl.scrollHeight;
}

function appendLogElement(el) {
  logEl.appendChild(el);
  logEl.scrollTop = logEl.scrollHeight;
}

function startStream() {
  appendLog('üîó ≈ÅƒÖczenie z /api/generate-stream...');
  sendLog('connect', { endpoint: '/api/generate-stream' });
  const es = new EventSource('/api/generate-stream');
  es.addEventListener('open', () => {
    appendLog('üîå Po≈ÇƒÖczono z serwerem');
    sendLog('sse-open');
  });
  es.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    sendLog('sse-message', msg);
    if (msg.log) {
      appendLog(msg.log);
    }
  if (msg.warnings) {
    appendLog('‚ö†Ô∏è Ostrze≈ºenia:');
    const list = document.createElement('ul');
    msg.warnings.forEach(w => {
      const li = document.createElement('li');
      li.textContent = w;
      list.appendChild(li);
    });
    appendLogElement(list);
  }
  if (msg.errors) {
    appendLog('‚ùå B≈Çƒôdy:');
    const list = document.createElement('ul');
    msg.errors.forEach(er => {
      const li = document.createElement('li');
      li.textContent = er;
      list.appendChild(li);
    });
    appendLogElement(list);
  }
  if (msg.stats) {
    appendLog(`üìä Statystyki: roszczenia=${msg.stats.claims}, ze ≈∫r√≥d≈Çem=${msg.stats.withSource}, todo=${msg.stats.todo}`);
  }
  if (msg.recentTitles) {
    appendLog('üìö Ostatnie tytu≈Çy:');
    const list = document.createElement('ul');
    msg.recentTitles.forEach(t => {
      const li = document.createElement('li');
      li.textContent = t;
      list.appendChild(li);
    });
    appendLogElement(list);
  }
  if (msg.hotTopics) {
    appendLog('üî• GorƒÖce tematy:');
    const list = document.createElement('ul');
    msg.hotTopics.forEach(t => {
      const li = document.createElement('li');
      li.textContent = t;
      list.appendChild(li);
    });
    appendLogElement(list);
  }
  if (msg.topicSuggestions && !topicForm) {
    appendLog('üí° Propozycje temat√≥w:');
    topicForm = document.createElement('div');
    msg.topicSuggestions.forEach((s, i) => {
      const label = document.createElement('label');
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = 'topic';
      radio.value = s.title;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(`${s.title} ‚Äì ${s.rationale}`));
      topicForm.appendChild(label);
      topicForm.appendChild(document.createElement('br'));
    });
    const custom = document.createElement('input');
    custom.type = 'text';
    custom.id = 'custom-topic';
    custom.placeholder = 'W≈Çasny temat';
    topicForm.appendChild(custom);
    appendLogElement(topicForm);
  }
  if (msg.articleTitle) {
    appendLog(`üì∞ Nowy artyku≈Ç: ${msg.articleTitle}`);
  }
  if (msg.articlePrompt && msg.awaitingPrompt) {
    articlePromptEl.value = msg.articlePrompt;
    if (!promptShown) {
      appendLog('‚úè Prompt (artyku≈Ç):');
      appendLogElement(articlePromptEl);
      appendLogElement(continueBtn);
      promptShown = true;
    }
    articlePromptEl.removeAttribute('readonly');
    articlePromptEl.style.display = 'block';
    continueBtn.style.display = 'inline-block';

  }
  if (msg.heroPrompt) {
    appendLog('üé® Prompt (obrazek):');
    appendLog(msg.heroPrompt);
  }
    if (msg.done) {
      statusEl.textContent = 'Zako≈Ñczono!';
      prLinkEl.href = msg.url;
      prLinkEl.style.display = 'inline-block';
      sendLog('sse-complete', { url: msg.url });
      es.close();
    }
  };
  es.onerror = (err) => {
    statusEl.textContent = 'B≈ÇƒÖd po≈ÇƒÖczenia (SSE)';
    appendLog('‚ùå B≈ÇƒÖd po≈ÇƒÖczenia (SSE)');
    console.error('EventSource failed', err);
    sendLog('sse-error', { message: err.message });
    es.close();
  };

  continueBtn.addEventListener('click', async () => {
    continueBtn.disabled = true;
    try {
      appendLog('üì® Wysy≈Çam zaktualizowany prompt do /api/update-prompt...');
      sendLog('update-prompt-send', { endpoint: '/api/update-prompt' });
      const res = await fetch('/api/update-prompt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          prompt: articlePromptEl.value,
          topic: (() => {
            if (topicForm) {
              const checked = topicForm.querySelector('input[name="topic"]:checked');
              if (checked) return checked.value;
              const custom = document.getElementById('custom-topic');
              if (custom) return custom.value;
            }
            return '';
          })(),
        }),
        credentials: 'include',
      });
      if (!res.ok) throw new Error('status ' + res.status);
      sendLog('update-prompt-response', { status: res.status });
      appendLog('‚è≠ Kontynuujƒô tworzenie...');
      articlePromptEl.setAttribute('readonly', '');
      continueBtn.style.display = 'none';
    } catch (err) {
      appendLog(`‚ùå B≈ÇƒÖd podczas wysy≈Çania prompta: ${err}`);
      sendLog('update-prompt-error', { message: String(err) });
      continueBtn.disabled = false;
    }
  });
}
</script>
</body>
</html>
