<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<title>Generowanie artykułu</title>
<style>
body { font-family: sans-serif; padding: 2rem; }
#log { white-space: pre-wrap; background: #f4f4f4; padding: 1rem; border-radius: 4px; max-height: 60vh; overflow-y: auto; }
#panel { margin-bottom: 1em; }
#panel h2 { margin-top: 1em; }
#footer { margin-top: 2em; }
.home-button { display: inline-block; padding: 0.75em 1.5em; background: var(--diplomatic-blue, #1c3d5a); color: var(--ivory, #f8f6f1); border-radius: 4px; text-decoration: none; border: 2px solid var(--diplomatic-blue, #1c3d5a); margin-right: 1em; }
.home-button:hover { background: var(--gold-accent, #cba135); color: var(--charcoal, #2d2d2d); }
textarea { width: 100%; height: 8em; }
</style>
</head>
<body>
<h1>Generowanie artykułu</h1>
<div id="panel">
  <div id="status">Oczekiwanie na dane...</div>
  <h2>Ostatnie tytuły</h2>
  <ul id="titles"></ul>
  <h2>Nowy artykuł</h2>
  <p id="article-title"></p>
  <h2>Prompt (artykuł)</h2>
  <textarea id="article-prompt" readonly></textarea>
  <button id="continue-btn" style="display:none">Kontynuuj</button>
  <h2>Prompt (obrazek)</h2>
  <pre id="hero-prompt"></pre>
</div>
<pre id="log"></pre>
<div id="footer">
  <a id="pr-link" class="home-button" style="display:none">Zobacz PR</a>
  <a href="/" class="home-button">Strona główna</a>
</div>
<script>
const logEl = document.getElementById('log');
const statusEl = document.getElementById('status');
const titlesEl = document.getElementById('titles');
const articleTitleEl = document.getElementById('article-title');
const articlePromptEl = document.getElementById('article-prompt');
const heroPromptEl = document.getElementById('hero-prompt');
const prLinkEl = document.getElementById('pr-link');
const continueBtn = document.getElementById('continue-btn');
const es = new EventSource('/api/generate-stream');
es.onmessage = (e) => {
  const msg = JSON.parse(e.data);
  if (msg.log) {
    logEl.textContent += msg.log + '\n';
  }
  if (msg.recentTitles) {
    titlesEl.innerHTML = msg.recentTitles.map(t => `<li>${t}</li>`).join('');
  }
  if (msg.articleTitle) {
    articleTitleEl.textContent = msg.articleTitle;
  }
  if (msg.articlePrompt) {
    articlePromptEl.value = msg.articlePrompt;
  }
  if (msg.awaitingPrompt) {
    articlePromptEl.removeAttribute('readonly');
    continueBtn.style.display = 'inline-block';
  }
  if (msg.heroPrompt) {
    heroPromptEl.textContent = msg.heroPrompt;
  }
  if (msg.done) {
    statusEl.textContent = 'Zakończono!';
    prLinkEl.href = msg.url;
    prLinkEl.style.display = 'inline-block';
    es.close();
  }
};
es.onerror = () => {
  statusEl.textContent = 'Błąd połączenia';
  es.close();
};

continueBtn.addEventListener('click', async () => {
  continueBtn.disabled = true;
  await fetch('/api/update-prompt', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ prompt: articlePromptEl.value }),
  });
  articlePromptEl.setAttribute('readonly', '');
  continueBtn.style.display = 'none';
});
</script>
</body>
</html>
